#!/usr/bin/env python
import sys
import json
import datetime
import re
import os
import docopt
from hackytrack import utils


doc = """ hackyanalyze

    Analyzes hackytrack output files. If run without options current day's file
    will be analyzed.

    Usage: hackyanalyze [<filename>] [-v...]

    Options:
        -v                  Outputs more tracking info from given file.
                            Add additional v characters to show more
                            detail.
                            [default: 0]

    Arguments:
        <filename>          Name of file to analyze. If not given it defaults to current day's file.
"""

args = docopt.docopt(doc)
filename = args.get("<filename>")

if not filename:
    filename = utils.get_today()

if not os.path.isfile(filename):
    print "Error file {0} does not exist".format(filename)
    sys.exit(1)

contents = ""
with open(filename) as f:
    contents = f.read()

contents = json.loads(contents)
sub_totals = {}
total = datetime.timedelta()

for item in contents:
    if "elapsed" not in item:
        continue

    key = "OTHER"

    name = item["name"]
    if ":" in name:
        key = re.search(".*?(?=:)", name).group(0)
        name = re.sub(".*?:", "", name, 1).strip()

    elapsed = item["elapsed"]
    d = datetime.datetime.strptime(elapsed, "%H:%M:%S.%f")
    delta = datetime.timedelta(hours=d.hour, minutes=d.minute, seconds=d.second, microseconds=d.microsecond)
    if key not in sub_totals:
        sub_totals[key] = {}
        sub_totals[key]["total"] = delta
        sub_totals[key]["task_list"] = []
    else:
        sub_totals[key]["total"] += delta

    sub_totals[key]["task_list"].append("{0}: {1}".format(name, delta))

    total += delta

for total_type, item_data in sub_totals.iteritems():
    print "{0}: {1}".format(total_type, item_data["total"])
    if args["--more"]:
        for task in item_data["task_list"]:
            print "\t{0}".format(task)

print "{0}: {1}".format("Total", total)
